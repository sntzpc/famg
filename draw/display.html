<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FG - Display</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { fontFamily: { sans: ["Poppins","ui-sans-serif","system-ui"] } } } }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen font-sans">

  <div class="max-w-6xl mx-auto px-4 py-8 md:py-12">
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-4xl font-extrabold tracking-tight">Pengacakan Unit Peserta Lomba</h1>
        <p class="text-slate-600 mt-1">Display publik (tanpa login) — muncul satu per satu otomatis setelah tombol <b>ACAK</b> ditekan di Trigger.</p>
      </div>

      <div class="flex flex-wrap gap-2 items-center">
        <div class="text-sm font-bold text-slate-500 mr-2">
          <span class="inline-flex items-center gap-2">
            <span id="dot" class="h-2 w-2 rounded-full bg-emerald-500"></span>
            <span id="live">LIVE</span>
          </span>
        </div>
        <button id="btnExport" class="rounded-2xl px-4 py-2.5 font-extrabold bg-slate-900 text-white hover:bg-slate-800">Export XLSX</button>
        <button id="btnRefresh" class="rounded-2xl px-4 py-2.5 font-extrabold bg-white border hover:bg-slate-50">Refresh</button>
      </div>
    </div>

    <!-- LIST: big, no table -->
    <div class="mt-8 rounded-3xl border bg-white shadow-sm overflow-hidden">
      <div class="p-4 md:p-6 border-b bg-gradient-to-br from-white to-slate-50 flex items-center justify-between">
        <div class="text-sm font-extrabold">Urutan tampil</div>
        <div class="text-sm text-slate-500"><span id="count">0</span> item</div>
      </div>

      <div id="empty" class="p-8 md:p-12 text-center text-slate-500">
        Menunggu trigger…
      </div>

      <div id="list" class="hidden divide-y"></div>
    </div>
  </div>

  <script src="./js/config.js"></script>
  <script src="./js/app.js"></script>
  <script>
    ensureToastHost();

    const listEl = $("#list");
    const emptyEl = $("#empty");
    const countEl = $("#count");
    const liveEl = $("#live");
    const dotEl = $("#dot");

    let lastTotal = 0;
    let showCount = 0;
    let revealTimer = null;

    function stopReveal(){
      if(revealTimer){
        clearInterval(revealTimer);
        revealTimer = null;
      }
    }

    function render(items){
      const total = items.length;
      countEl.textContent = String(total);

      if(total === 0){
        listEl.classList.add("hidden");
        emptyEl.classList.remove("hidden");
        emptyEl.textContent = "Menunggu trigger…";
        return;
      }

      emptyEl.classList.add("hidden");
      listEl.classList.remove("hidden");

      const visible = items.slice(0, showCount);
      listEl.innerHTML = visible.map((it, idx)=>{
        const isLast = (idx === visible.length - 1);
        return `
          <div class="p-5 md:p-8 ${isLast ? "bg-emerald-50/60" : "bg-white"}">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div class="flex items-center gap-4">
                <div class="h-12 w-12 md:h-16 md:w-16 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-extrabold text-xl md:text-2xl">${it.drawNo}</div>
                <div>
                  <div class="text-3xl md:text-5xl font-extrabold leading-tight">${escapeHtml(it.unit)}</div>
                  <div class="mt-2">
                    <span class="inline-flex rounded-full border px-3 py-1 text-sm md:text-base font-extrabold ${badgeCat(it.category)}">${formatCat(it.category)}</span>
                  </div>
                </div>
              </div>
              <div class="text-sm md:text-base text-slate-500 font-semibold">
                ${it.ts ? new Date(it.ts).toLocaleString("id-ID") : ""}
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    function startReveal(items){
      stopReveal();
      showCount = 0;
      render(items);
      revealTimer = setInterval(()=>{
        if(showCount < items.length){
          showCount++;
          render(items);
          // auto scroll to bottom to show newest
          window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
        } else {
          stopReveal();
        }
      }, 850);
    }

    async function refresh(){
      try{
        dotEl.className = "h-2 w-2 rounded-full bg-emerald-500";
        liveEl.textContent = "LIVE";

        const l = await api("draw.list");
        if(!l.ok) throw new Error(l.error || "Gagal ambil data");
        const items = (l.items || []).sort((a,b)=> (a.drawNo||0) - (b.drawNo||0));

        // detect reset
        if(items.length === 0){
          lastTotal = 0;
          showCount = 0;
          stopReveal();
          render([]);
          return;
        }

        // new run detected: previous was 0, now >0 OR drawNo restarted at 1
        const isNewRun = (lastTotal === 0 && items.length > 0) || (items[0].drawNo === 1 && lastTotal > 0 && items.length >= 1 && (items.length !== lastTotal));
        lastTotal = items.length;

        if(isNewRun){
          startReveal(items);
        } else {
          // continue reveal if new items appended
          if(showCount < items.length && !revealTimer){
            showCount = Math.min(showCount, items.length);
            // reveal remaining
            revealTimer = setInterval(()=>{
              if(showCount < items.length){
                showCount++;
                render(items);
                window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
              } else {
                stopReveal();
              }
            }, 850);
          } else {
            // keep current showCount
            if(showCount === 0) showCount = items.length;
            render(items);
          }
        }
      }catch(e){
        dotEl.className = "h-2 w-2 rounded-full bg-red-500";
        liveEl.textContent = "OFFLINE";
      }
    }

    $("#btnRefresh").onclick = refresh;

    $("#btnExport").onclick = async ()=>{
      try{
        const l = await api("draw.list");
        if(!l.ok) throw new Error(l.error || "Gagal ambil data");
        const items = (l.items || []).sort((a,b)=> (a.drawNo||0) - (b.drawNo||0));
        if(items.length === 0) throw new Error("Belum ada hasil untuk diexport");
        const wsData = [["No","Unit","Kategori","Waktu (ISO)","Operator (NIK)"]].concat(
          items.map(it=>[it.drawNo, it.unit, it.category, it.ts, it.byNik])
        );
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Hasil");
        XLSX.writeFile(wb, "FG_Hasil_Pengacakan_Unit.xlsx");
        toast("Export XLSX berhasil", "ok");
      }catch(e){
        toast(e.message, "err");
      }
    };

    refresh();
    setInterval(refresh, (typeof DISPLAY_POLL_MS !== "undefined" ? DISPLAY_POLL_MS : 1200));
  </script>
</body>
</html>
