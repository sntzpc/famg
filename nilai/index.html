<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FG - Penilaian</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Poppins', 'ui-sans-serif', 'system-ui'] }
        }
      }
    }
  </script>

  <!-- Fonts + Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Ctext y='54' x='6' font-size='56'%3E%F0%9F%8F%85%3C/text%3E%3C/svg%3E" />

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100 text-slate-800 font-sans">
  <!-- Top Bar -->
  <header class="sticky top-0 z-30 border-b border-slate-200/70 bg-white/70 glass">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-slate-900 text-white grid place-items-center shadow-sm">
          <i class="fa-solid fa-trophy"></i>
        </div>
        <div>
          <div id="appTitle" class="font-bold leading-tight">Penilaian Family Gathering</div>
          <div class="text-xs text-slate-500">
            Event: <span id="eventIdLabel" class="font-semibold">-</span>
            <span class="mx-2">•</span>
            <span id="statusOnline" class="badge bg-slate-100 text-slate-700"><i class="fa-solid fa-signal"></i> Offline</span>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnUser" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 shadow-sm">
          <i class="fa-solid fa-user"></i><span id="userLabel">Login</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Tabs -->
    <div class="flex flex-wrap items-center gap-2 mb-4">
      <button class="tabbtn px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50" data-tab="rate" aria-selected="true">
        <i class="fa-solid fa-star mr-2"></i>Penilaian
      </button>
      <button class="tabbtn px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50" data-tab="results" aria-selected="false">
        <i class="fa-solid fa-chart-column mr-2"></i>Rekap
      </button>
      <button class="tabbtn px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50" data-tab="failed" aria-selected="false">
        <i class="fa-solid fa-triangle-exclamation mr-2"></i>Gagal <span id="failedCount" class="ml-1 text-xs font-semibold text-rose-600">(0)</span>
      </button>
      <button id="tabAdminBtn" class="tabbtn px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 hidden" data-tab="admin" aria-selected="false">
        <i class="fa-solid fa-gear mr-2"></i>Admin
      </button>

      <div class="ml-auto flex items-center gap-2">
        <button id="btnExport" class="px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50">
          <i class="fa-solid fa-file-excel mr-2 text-emerald-700"></i>Export XLSX
        </button>
        <button id="btnResetLocal" class="px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50">
          <i class="fa-solid fa-trash mr-2 text-rose-700"></i>Reset Local
        </button>
      </div>
    </div>

    <!-- Tab: Penilaian -->
    <section id="tab-rate" class="tabpane">
      <div class="grid lg:grid-cols-3 gap-4">
        <div class="lg:col-span-1">
          <div class="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
            <div class="font-semibold mb-3">Info Penilaian</div>

            <label class="block text-sm text-slate-600 mb-1">Tanggal Penilaian</label>
            <input id="eventDate" type="date" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/20"/>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="text-xs text-slate-500">Juri</div>
                <div id="judgeName" class="font-semibold">-</div>
              </div>
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="text-xs text-slate-500">Outbox</div>
                <div class="font-semibold"><span id="pendingCount">0</span> pending</div>
              </div>
            </div>

            <div class="mt-4 space-y-2">
              <label class="block text-sm text-slate-600 mb-1">Jenis Lomba</label>
              <select id="competitionType" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/20"></select>

              <label class="block text-sm text-slate-600 mb-1">Tim</label>
              <select id="teamSelect" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/20"></select>

              <button id="btnResetForm" class="w-full mt-2 px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">
                <i class="fa-solid fa-rotate-left mr-2"></i>Reset Form
              </button>
            </div>
          </div>
        </div>

        <div class="lg:col-span-2">
          <div class="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm min-h-[360px]">
            <div class="flex items-center justify-between gap-3 mb-3">
              <div>
                <div class="font-semibold">Form Penilaian</div>
                <div class="text-xs text-slate-500">Skor 1–<span id="maxStarsLabel">5</span> bintang</div>
              </div>
            </div>

            <div id="noTeamSelected" class="p-10 rounded-2xl border border-dashed border-slate-300 text-center text-slate-500">
              Pilih <b>Jenis Lomba</b> dan <b>Tim</b> untuk mulai menilai.
            </div>

            <div id="criteriaContainer" class="space-y-4 hidden"></div>
          </div>
        </div>

        <div class="mt-4 p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div class="font-semibold">Aksi</div>
              <div id="lockBadge" class="badge bg-slate-100 text-slate-700 hidden"><i class="fa-solid fa-lock"></i> Locked</div>
            </div>
            <button id="btnSaveRating" class="hidden mt-3 px-4 py-3 rounded-2xl bg-emerald-600 text-white hover:bg-emerald-700 shadow-sm">
              <i class="fa-solid fa-floppy-disk mr-2"></i>Simpan Penilaian          
            </button>
            <button id="btnSyncNow" class="w-full mt-3 px-4 py-3 rounded-2xl bg-slate-900 text-white hover:bg-slate-800 shadow-sm">
                <i class="fa-solid fa-floppy-disk mr-2"></i><span>Simpan Penilaian</span>
            </button>
            <p class="text-xs text-slate-500 mt-3 leading-relaxed">
              * Jika gagal Sync, data masuk ke tab <b>Gagal Sync</b>.
            </p>
          </div>
      </div>
    </section>

    <!-- Tab: Rekap -->
    <section id="tab-results" class="tabpane hidden">
      <div class="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
        <div class="flex flex-col md:flex-row md:items-end gap-3">
          <div class="flex-1">
            <div class="font-semibold">Rekap & Peringkat</div>
            <div class="mt-2 flex flex-wrap gap-2">
              <button id="btnRecapServer" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-sm">
                <i class="fa-solid fa-cloud-arrow-down mr-2"></i>Tarik dari Server
              </button>
              <button id="btnRecapLocal" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-sm">
                <i class="fa-solid fa-database mr-2"></i>Pakai Data Lokal
              </button>
              <span id="recapSourceHint" class="text-xs text-slate-500 self-center"></span>
            </div>
            <div class="text-xs text-slate-500">Filter lomba/juri. Skor = Σ (rating × bobot/100).</div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 w-full md:w-auto">
            <div>
              <label class="block text-xs text-slate-600 mb-1">Jenis Lomba</label>
              <select id="filterCompetition" class="w-full px-3 py-2 rounded-xl border border-slate-200"></select>
            </div>
            <div>
              <label class="block text-xs text-slate-600 mb-1">Juri</label>
              <select id="filterJudge" class="w-full px-3 py-2 rounded-xl border border-slate-200"></select>
            </div>
            <div>
              <label class="block text-xs text-slate-600 mb-1">Mode</label>
              <select id="filterMode" class="w-full px-3 py-2 rounded-xl border border-slate-200">
                <option value="sum">Total (gabung)</option>
                <option value="avg">Rata-rata antar juri</option>
              </select>
            </div>
          </div>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-slate-600">
              <tr class="border-b">
                <th class="text-left py-2 pr-4">Rank</th>
                <th class="text-left py-2 pr-4">Lomba</th>
                <th class="text-left py-2 pr-4">Tim</th>
                <th class="text-right py-2 pr-4">Skor</th>
                <th class="text-right py-2 pr-4">Adjustment</th>
                <th class="text-right py-2 pr-4">Final</th>
                <th class="text-right py-2 pr-4">Juri</th>
              </tr>
            </thead>
            <tbody id="resultsBody" class="divide-y"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Tab: Gagal Sync -->
    <section id="tab-failed" class="tabpane hidden">
      <div class="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="font-semibold">Antrian Gagal Sync</div>
          </div>
          <button id="btnRetryAll" class="px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700">
            <i class="fa-solid fa-rotate mr-2"></i>Retry Semua
          </button>
        </div>

        <div id="failedList" class="mt-4 space-y-3"></div>
      </div>
    </section>

    <!-- Tab: Admin -->
    <section id="tab-admin" class="tabpane hidden">
      <div class="grid lg:grid-cols-3 gap-4">

        <!-- Panel: Permintaan OTP (Unlock Penilaian) -->
        <div id="otpReqAdminPanel" class="lg:col-span-3 p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="font-semibold">Permintaan OTP (Unlock Penilaian)</div>
              <div class="text-xs text-slate-600 mt-1">Juri mengajukan OTP dari modal OTP. Admin menekan <b>Setujui</b>, lalu OTP bisa dicopy dan akan bisa diambil juri lewat tombol <b>Cek OTP Saya</b>.</div>
            </div>
            <button id="btnOtpReqReload" class="px-4 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200">
              <i class="fa-solid fa-rotate mr-2"></i>Refresh
            </button>
          </div>
          <div id="otpReqAdminList" class="mt-4 space-y-3"></div>
        </div>


        <!-- Panel: Password Admin -->
        <div class="lg:col-span-3 p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="font-semibold">Password</div>
              <div class="text-xs text-slate-600 mt-1">Ubah password admin atau reset ke default <b>admin123</b>.</div>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-1 lg:grid-cols-3 gap-2">
            <input id="adminNewPass" type="password" class="px-3 py-3 rounded-2xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/20" placeholder="Password baru (min 6 karakter)" />
            <button id="btnAdminChangePass" class="px-4 py-3 rounded-2xl bg-slate-900 text-white hover:bg-slate-800">
              <i class="fa-solid fa-key mr-2"></i>Ganti Password
            </button>
            <button id="btnAdminResetPass" class="px-4 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200">
              <i class="fa-solid fa-rotate-left mr-2"></i>Reset ke Default
            </button>
          </div>
          <div id="adminPassMsg" class="mt-2 text-sm text-slate-600 hidden"></div>
        </div>

        <!-- Panel: Manajemen Juri -->
        <div class="lg:col-span-3 p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="font-semibold">Manajemen Juri</div>
              <div class="text-xs text-slate-600 mt-1">Admin bisa mengaktifkan/menonaktifkan status <b>juri</b> pada daftar staff (sheet <b>data_staff</b> kolom <b>juri</b>).</div>
            </div>
            <div class="flex items-center gap-2">
              <input id="staffSearch" class="px-3 py-2 rounded-xl border border-slate-200 w-64" placeholder="Cari NIK / Nama / Unit…" />
              <button 
              <label class="flex items-center gap-2 text-xs text-slate-600 select-none">
                <input id="staffShowAll" type="checkbox" class="rounded border-slate-300" />
                Tampilkan semua staff
              </label>
id="btnStaffReload" class="px-4 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200">
                <i class="fa-solid fa-rotate mr-2"></i>Refresh
              </button>
            </div>
          </div>
          <div class="mt-4 overflow-auto">
            <table class="w-full text-sm">
              <thead class="text-xs uppercase text-slate-500 border-b">
                <tr>
                  <th class="text-left py-2 pr-2">NIK</th>
                  <th class="text-left py-2 pr-2">Nama</th>
                  <th class="text-left py-2 pr-2">Region</th>
                  <th class="text-left py-2 pr-2">Unit</th>
                  <th class="text-left py-2 pr-2">Status</th>
                  <th class="text-left py-2 pr-2">Juri</th>
                  <th class="text-right py-2">Aksi</th>
                </tr>
              </thead>
              <tbody id="staffList" class="divide-y"></tbody>
            </table>
          </div>
          <div class="mt-3 text-xs text-slate-500">Tip: gunakan pencarian untuk cepat menemukan staff, lalu klik tombol <b>Aktifkan</b> / <b>Nonaktifkan</b>.</div>
        </div>


        <div class="lg:col-span-1">
          <div class="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
            <div class="font-semibold mb-2">Pengaturan Aplikasi</div>

            <label class="block text-sm text-slate-600 mb-1">Judul</label>
            <input id="cfgTitle" class="w-full px-3 py-2 rounded-xl border border-slate-200" />

            <label class="block text-sm text-slate-600 mb-1 mt-2">Event ID</label>
            <input id="cfgEventId" class="w-full px-3 py-2 rounded-xl border border-slate-200" />

            <label class="block text-sm text-slate-600 mb-1 mt-2">Max Bintang</label>
            <input id="cfgMaxStars" type="number" min="3" max="10" class="w-full px-3 py-2 rounded-xl border border-slate-200" />

            <button id="btnSaveConfig" class="w-full mt-3 px-4 py-3 rounded-2xl bg-slate-900 text-white hover:bg-slate-800">
              <i class="fa-solid fa-cloud-arrow-up mr-2"></i>Simpan Config
            </button>

            <button id="btnReloadConfig" class="w-full mt-2 px-4 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200">
              <i class="fa-solid fa-rotate mr-2"></i>Reload dari Server
            </button>
          </div>

          <div class="mt-4 p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
            <div class="font-semibold mb-2">Adjustment (Kesepakatan Juri)</div>
            <div class="grid grid-cols-1 gap-2">
              <select id="adjCompetition" class="w-full px-3 py-2 rounded-xl border border-slate-200"></select>
              <select id="adjTeam" class="w-full px-3 py-2 rounded-xl border border-slate-200"></select>
              <input id="adjValue" type="number" step="0.01" class="w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="Nilai (+/-)"/>
              <input id="adjNote" class="w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="Catatan singkat"/>
              <button id="btnSaveAdjustment" class="w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white hover:bg-emerald-700">
                <i class="fa-solid fa-check mr-2"></i>Simpan Adjustment
              </button>
            </div>
          </div>
        </div>

        <div class="lg:col-span-2">
          
          <div class="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-semibold">Editor</div>
              </div>
              <button id="btnAddCompetition" class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">
                <i class="fa-solid fa-plus mr-2"></i>Tambah Lomba
              </button>
            </div>

            <div id="cfgBuilder" class="mt-3 space-y-3"></div>

            <!-- Advanced (opsional) -->
            <div class="mt-4 pt-4 border-t border-slate-200">
              <button id="btnToggleAdvanced" class="w-full px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-left">
                <i class="fa-solid fa-code mr-2"></i>Mode Advanced (JSON) <span class="text-xs text-slate-500">(opsional)</span>
              </button>

              <div id="cfgAdvancedBox" class="mt-3 hidden">
                <div class="flex items-center justify-between">
                  <div class="text-sm font-semibold text-slate-700">JSON Config</div>
                  <button id="btnBeautifyJson" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">
                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Rapikan JSON
                  </button>
                </div>

                <textarea id="cfgJson" class="mt-3 w-full h-[320px] px-3 py-2 rounded-2xl border border-slate-200 font-mono text-xs"></textarea>

                <div class="mt-3 flex flex-col sm:flex-row gap-2">
                  <button id="btnApplyJsonToForm" class="flex-1 px-4 py-3 rounded-2xl bg-slate-900 text-white hover:bg-slate-800">
                    <i class="fa-solid fa-arrow-turn-down mr-2"></i>Terapkan JSON ke Form
                  </button>
                  <button id="btnPreviewAdminCalc" class="flex-1 px-4 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200">
                    <i class="fa-solid fa-eye mr-2"></i>Preview Rekap dari Server
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 z-40 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 grid place-items-center p-4">
      <div class="w-full max-w-md p-5 rounded-3xl bg-white shadow-xl">
        <div class="flex items-center justify-between">
          <div>
            <div class="font-bold text-lg">Login</div>
          </div>
          <button id="btnCloseLogin" class="h-10 w-10 rounded-2xl bg-slate-100 hover:bg-slate-200 grid place-items-center">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div class="mt-4">
  <div class="flex items-center gap-2">
    <button id="loginModeJuri" class="flex-1 px-3 py-2 rounded-2xl bg-slate-900 text-white hover:bg-slate-800">Juri</button>
    <button id="loginModeAdmin" class="flex-1 px-3 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200">Admin</button>
  </div>

  <!-- Juri -->
  <div id="loginPanelJuri" class="mt-4">
    <label class="block text-sm text-slate-600 mb-1">NIK STAFF</label>
    <input id="loginNik" inputmode="numeric" class="w-full px-3 py-3 rounded-2xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/20" placeholder="contoh: 20141234"/>
    <div class="mt-2 text-xs text-slate-500">Login juri hanya menggunakan NIK STAFF.</div>
  </div>

  <!-- Admin -->
  <div id="loginPanelAdmin" class="mt-4 hidden">
    <label class="block text-sm text-slate-600 mb-1">Username</label>
    <input id="loginUser" class="w-full px-3 py-3 rounded-2xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/20" placeholder="admin"/>
    <label class="block text-sm text-slate-600 mb-1 mt-3">Password</label>
    <input id="loginPass" type="password" class="w-full px-3 py-3 rounded-2xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-900/20" placeholder="••••••••"/>
  </div>

  <button id="btnDoLogin" class="w-full mt-4 px-4 py-3 rounded-2xl bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-70 disabled:cursor-not-allowed">
    <span class="inline-flex items-center justify-center gap-2">
      <span id="loginSpinner" class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
      <i id="loginIcon" class="fa-solid fa-right-to-bracket"></i>
      <span id="loginBtnText">Login</span>
    </span>
  </button>
  <div id="loginMsg" class="mt-3 text-sm text-rose-600 hidden"></div>
</div>

        <div class="mt-4 p-3 rounded-2xl bg-slate-50 border border-slate-200 text-xs text-slate-600">
          <b>Catatan:</b> Session tersimpan 24 jam di perangkat ini.
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toastHost" class="fixed z-50 top-4 right-4 space-y-2"></div>

<script src="script.js"></script>

</body>
</html>
